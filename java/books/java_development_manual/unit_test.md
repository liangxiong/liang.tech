# 单元测试
## why
- 祸乱生于疏忽，单元测试先于交付
- 单元测试的目的是在集成测试和功能测试之前，对软件中的可测试单元进行逐一检查和验证

## what
- 系统由多模块组成，模块由子模块组成，模块由不可分的程序单元组成
- 单元测试是程序功能的基本保障
- 程序员 纠结：
  - 评估时间，如果需要额外时间来写单测，外行领导会按捺不住。这其实应该形成潜意识
  - 他其实是一件有情怀，有技术素养，有长远收益的工作
  - 他是保障软件质量和效率的重要手段之一

## how  
- 测试粒度要足够小，有助于精确定位问题，默认：方法级别
- 不负责检查 集成测试的覆盖范围 如：跨类或跨系统的交互逻辑
- [测试用例在项目中的感受](https://github.com/liangxiong/liang.tech/blob/master/test/tdd.md)

### 优点
#### 提示软件质量
- 保障开发质量和程序的鲁棒性
- 越早发现的缺陷，修复成本越低
- 三种测试境界：
  - 一流的测试能发现未发生的故障
  - 二流的测试鞥快速定位故障的发生点
  - 三流的测试则疲于奔命，一直跟在故障后面进行功能回归

#### 促进代码优化
- 开发自己写
  - 会促使不断重新审视自己的代码，白盒地去思考代码逻辑
  - 更好地对代码进行设计
  - 想法设法的地优化测试用例的执行效率
  - 以上行为，要慢慢形成潜意识

#### 提示研发效率
- 磨刀不误砍柴工：虽然写单元测试花费了更多时间
- 但是后续的联调，集成，回归测试阶段，通常缺陷少，问题易修复
- 提升整体研发效率

#### 增加重构自信
- 重构完，单元测试 100% 执行通过，充满自信和成就感
- 你敢重构，也是一个潜意识的行为


### 基本原则：
#### AIR原则，用例如空气般存在
- 包含：
  - A: Automatic 自动化
    - 它是应该频繁的完全自动执行,使用断言来验证

  - I: Independent 独立性
    - 用例之间，不允许互相调用
    - 也不允许出现，执行次序的先后依赖

  - R: Repeatable 可重复性
    - 每次提交代码，自动触发执行

#### BCDE 原则 分：
- B：Border，边界值测试

- C：Correct，正确的输入，并得到预期的结果

- D：Design，与设计文档相结合，来编写单元测试

- E：Error，为了验证错误，强制的错误输入（非法数据，异常流程，非业务允许输入），来得到预期的错误结果。


#### Mock：
- 有些因素导致依赖的数据不存在 大概分：
  - 功能因素；
    - 被测试方法内部调用的功能不可用
  - 时间因素：
    - 比如：双11还没到
  - 环境因素：
    - 政策环境
  - 数据因素：
    - 线下数据样本小，难以覆盖各种线上真实场景
  - 其他因素：
    - 为了简化测试的编写


#### 测试覆盖率
- 粗粒度的覆盖率
  - 类覆盖：只要覆盖了这个类的方法或变量被测试了
  - 方法覆盖：只要测试了这个方法

- 细粒度的覆盖率: 复杂度 从小到大。todo：更人话？
  - case:（a == 1 && b == 2 || c == 3）
  - 行覆盖率：用例跑了每行的代码
    - 分子：执行到的语句行数，分母：可执行语句行数
    - 缺点：比如判断语句的条件多个，覆盖率足够好：应该这行代码中的各种条件参数都该测试

  - 分支覆盖：
    - 分子：被执行到的分支数， 分母：所有分支总数
    - 分支中的：真假2种情况
    - case：
      - 1，2，3
      = 0，0，0

  - 条件判定覆盖：
    - 让每个判定本身的所有可能结果至少执行一次
    - case：
      - 0，2，3
      - 1，0，3
      - 0，0，0

  - 路径覆盖
    - 覆盖所有可能的路径

  - 条件组合覆盖
    - 让判定中所有条件的各种组合都出现至少一次
    - case：
      - 1 + 2 + 3 = 6

#### 断言和假设
- asset 断言：
  - 封装了常用的判断逻辑，不满足时，认定为测试失败
  -
  - junit 分装在：org.junit.jupiter.api.Assertions

- assume 假设：
  - 不满足时，直接退出而不是认定为测试失败，最终记录状态是跳过
  - junit 分装在：org.junit.jupiter.api.Assumptions

## 工具
### 单元测试框架：
- Junit
- AssertJ

### Mock 框架：
- JMockit
- EasyMock
- JMock
