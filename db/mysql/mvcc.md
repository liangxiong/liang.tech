# MVVC 多版本并发控制

- 流程
  - 回滚段：每条记录在更新时都会同时记录一条回滚操作
  - 记录的最新值，通过回滚操作，都可以得到前一个状态的值
  - 回滚段在mysql <= 5.5时候放在ibdata

- 优点：
  - InnoDB的事务隔离级别下执行一致性
  - 查询一些正在被另一个事务更新的行
  - 并且可以看到它们被更新之前的值
  - 增强并发性的强大的技术，查询就不用等待另一个事务释放锁

- 手段：
  - DB_TRX_ID
  - DB_ROLL_PTR
  - DB_ROW_ID

- 流程：
  - SELECT
    - 读取创建版本小于或等于当前事务版本号，
    - 并且删除版本为空或大于当前事务版本号的记录。
    - 这样可以保证在读取之前记录是存在的。
   - INSERT
     - 将当前事务的版本号保存至行的创建版本号
   - UPDATE
     - 新插入一行，并以当前事务的版本号作为新行的创建版本号，同时将原记录行的删除版本号设置为当前事务版本号
   - DELETE
     - 将当前事务的版本号保存至行的删除版本号
  - 什么时候删除：
    - 系统判定 当么有事务再需要用到这些回滚日志时，他会删除
    - 没有比这个回滚日志更早的 read-view 的时候，所以不要用长事务,导致回滚段清理问题

- 长事务：
  - 查询：select * from information_schma.innodb_trx where TIME_TO_SEC(timdiff(now(),trx_started)) > 60
