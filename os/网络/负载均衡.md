# 负载均衡

![7层网络](https://github.com/liangxiong/liang.tech/blob/master/os/res/7net.png)

![7层网络上的业务明细](https://github.com/liangxiong/liang.tech/blob/master/os/res/7net_detail.png)


#### 负载均衡器
- 2层负载均衡会通过一个虚拟 MAC 地址接收请求，然后再分配到真实的 MAC 地址；
- 3层负载均衡会通过一个虚拟 IP 地址接收请求，然后再分配到真实的 IP 地址；

- 4层通过虚拟 IP + 端口接收请求，然后再分配到真实的服务器；
    - 四层的负载均衡，就是通过发布三层的 IP 地址（VIP），然后加四层的端口号，来决定哪些流量需要做负载均

- 7层通过虚拟的 URL 或主机名接收请求，然后再分配到真实的服务器。
所谓的四到七层负载均衡，就是在对后台的服务器进行负载均衡时，依据四层的信息或七层的信息来决定怎么样转发流量。
  - 根据 VIP 加 80 端口辨别是否需要处理的流量， 还可根据七层的 URL、浏览器类别、语言来决定

#### 交互机
- 四层交换机  本质：转发
  - 主要分析 IP 层及 TCP/UDP 层，实现四层流量负载均衡。  
  - 在 OSI 第 4 层工作，就是 TCP 层啦。
此种 Load Balancer 不理解应用协议（如 HTTP/FTP/MySQL 等等）。例子：LVS，F5
  - 原理：
    - 接收到第一个来自客户端的 SYN 请求时，即通过上述方式选择一个最佳的服务器， 并对报文中的目标 IP 地址进行修改(改为后端服务器 IP），直接转发给该服务器。 TCP 的连接建立，即三次握手是客户端和服务器直接建立的，负载均衡设备只是起到一个类似路由器的转发动作

- 七层交换机   本质：内容交换和代理
  - 除了支持四层负载均衡以外，还有分析应用层的信息，如 HTTP 协议 URI 或 Cookie 信息  
  - OSI 的最高层，应用层。此时，该 Load Balancer 能理解应用协议。例子： HAProxy，MySQL Proxy

#### 7层
- 缺点：
    - 配置复杂，特别规则多的情况下
- 优点：
    - 提供完善的七层功能，满足客户根据不同情况的基于应用的调度
    - 过滤 sql 注入
- todo:
    能够提供一个七层应用开发接口的负载均衡设备，可以让客户根据需求任意设定功能，才真正有可能提供强大的灵活性和智能性

#### 常用负载均衡
- LVS
- Nginx
- HAproxy

#### 算法：
- 静态负载均衡算法包括
  - 轮询：循环执行，遇到故障从顺序循环中拿出
  - 比率：分配一个加权比例，根据比率分配
  - 优先权：
- 动态负载均衡
- 随机
 - 轮询 Round Robin rr
 - 加权轮询 Weighted Round Robin wrr
 - 最少连接 Least Connections lc
 - 加权最少连接 Weighted Least Connections wlc
 - 基于局部性的最少链接 Locality-Baseed Least COnnections lblc
 - 最小负载  
 - 粘性会话，需要一致性哈希，相同的请求尽可能落到同一个服务器上

#### 一致性哈希
- 指定key 用于hash 计算
  - 请求方ip
  - 请求客户端名称
  - 用户ID

- hash 算法
  - 第一代：SHA-1（1993），MD5（1992），CRC（1975），Lookup3（2006）
  - 第二代：MurmurHash（2008）
  - 第三代：CityHash， SpookyHash（2011）
  - 专门：Ketama

- 算法考虑：    
  - 实现复杂程度
  - 均匀层度
  - 碰撞概率
  - 性能
- 过程：
  - 将服务器（ip+端口号）进行哈希，映射成环上的一个节点
  - 请求时：根据指定的 hash key 同样映射到环上，并顺时针选取最近的一个服务器节点进行请求
- 注意
  - 当节点少：遇到大量的请求到同一个环上时，需要引入虚拟节点的概念

### 测试
- 方法：
  - 测量流量分布均匀情况：统计每个服务节点收到的流量，计算方差、标准差
  - 测量节点上下线的影响：记录 m 次请求落到的服务器节点，下线 20% 的服务器，重放流量，统计 m 次请求中落到跟原先相同服务器的概率

- 比较：
  - 方差和标准差反映了均匀情况，越低越好
  - 不变流量比例体现了服务器上下线对原有请求的影响程度，不变流量比例越高越高
|                                     |   方差                      |          标准差      |  不变流量比例 |

| ------ | ------ | ------ |
| JdkHashCodeStrategy  |    29574.08   |  171.97  |   0.6784 |
| CRCHashStrategy   |   3013.02   |  54.89   |  0.7604 |
| FnvHashStrategy    | 792.02   |  28.14   |  0.7892 |
| KetamaHashStrategy  |    1147.08 |    33.86  |   0.80 |
| MurmurHashStrategy  |   634.82  |   25.19  |   0.80 |
