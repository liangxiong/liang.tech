# InnoDB记录结构
- https://dev.mysql.com/doc/refman/5.7/en/innodb-storage-engine.html


## 记录结构
- 指定表的行格式：ALTER TABLE 表名 ROW_FORMAT=行格式名称
  - COMPACT
  - Redundant
  - Dynamic
  - Compressed行格式
  - 指定列格式：CREATE TABLE 表名 (列的信息) ROW_FORMAT=行格式名称

### COMPACT行格式
- 在 MySQL5.0 中引入
- 记录的额外信息：为了描述这条记录而不得不额外添加的一些信息
  - 变长字段长度列表：逆序排列
    - 如：VARCHAR(M)、VARBINARY(M)、各种TEXT类型、各种BLOB类型,变长字符集的CHAR(N)
    - 记录：字节长度：字符集字符长度 * 最多存储字符数。解析器: 先根据表结构来判断是读1 or 2字节
    - <= 255: 使用1个字节存储
    - > 255:
      - 实际存储 <= 127: 使用1个字节, 第一个位为0
      - 实际存储 > 127 : 使用2个字节, 第一个位为1
      - 如何区分是1个字节还是2个字节存储：
        - 第一个位为0: 表示1字节存储
        - 第一个位为1: 表示字节存储

  - NULL值列表：所有可NULL字段逆序排列
    - 为1时，代表该列的值为NULL
    - 为0时，代表该列的值不为NULL
    - 不足一个字节，高位补0

  - 记录头信息 5个字节组成，40个二进制位，不同的位代表不同的意思
    - 预留位1	      1bit	没有使用
    - 预留位2	      1bit	没有使用
    - delete_mask	  1bit	标记该记录是否被删除
      - 被删除掉的记录会组成垃圾链表，在这个链表中的记录占用的空间称之为可重用空间
    - min_rec_mask	1bit	B+树的每层非叶子节点中的最小记录都会添加该标记
    - n_owned	      4bit	表示当前记录拥有的记录数
    - heap_no	      13bit	本页中的位置 从2开始
      - 自动有2个伪记录或虚拟记录，分别代表：最小记录，最大记录 分别是。比较的依据是主键的大小
        - infimum
        - supremum
        - 5字节大小的记录头信息和8字节固定的部分组成的
    - record_type	  3bit	表示当前记录的类型
      - 0 普通记录
      - 1 B+树非叶子节点记录
      - 2 最小记录
      - 3 最大记录
    - next_record	  16bit	表示下一条记录的相对位置

- 记录的真实数据：顺序排列
  - row_id：行ID，唯一标识一条记录  DB_ROW_ID
    - 非必须
    - 6字节
  - transaction_id：事务ID  DB_TRX_ID
	 - 必须
   - 6字节
  - roll_pointer：回滚指针  DB_ROLL_PTR
	 - 必须
   - 7字节
  - 字段1....n

- CHAR(M)列的存储格式
  - 分变长字符集
  - 定长字符集

### Redundant行格式  
- MySQL5.0之前用的一种行格式
- 记录额外的信息
  - 字段长度偏移列表   逆序排列
    - 字段的长度，需要通过 相邻数值的差值
    - 第1字节为1，表示值为NULL
    - 第1字节为0，表示值为非NULL
  - 记录头信息
    - 预留位1	        1bit	没有使用
    - 预留位2	        1bit	没有使用
    - delete_mask	    1bit	标记该记录是否被删除
    - min_rec_mask    1bit	B+树的每层非叶子节点中的最小记录都会添加该标记
    - n_owned	        4bit	表示当前记录拥有的记录数
    - heap_no	        13bit	表示当前记录在页面堆的位置信息
    - n_field	        10bit	表示记录中列的数量
    - 1byte_offs_flag	1bit	标记字段长度偏移列表中每个列对应的偏移量是使用1字节还是2字节表示的
      - 记录的真实数据占用的总大小来判断
        - <= 127 1字节
        - > 127 and < 32767 2字节
        > 32767：1字节，不过使用溢出页， 保留字符的前768个字节和20个字节溢出页面地址
    - next_record	    16bit	表示下一条记录的相对位置

- 记录的真实数据
  - row_id：行ID，唯一标识一条记录  同上
  - transaction_id：事务ID
  - roll_pointer：回滚指针
  - 字段1....n

- CHAR(M)列的存储格式
  - 真实数据空间始终为: 字符集最长长度 * 个数
  - 优点：不会产生碎片

### Dynamic和Compressed
- MySQL 5.7 中默认的行格式为 Dymatic

- 类似于COMPACT行格式, 处理行溢出数据时有点儿分歧，
  - 不会在记录真实数据处储存 真实数据的前 768 个字节
  - 把所有数据都存储到其他页面中，并且只储存其他页面的地址

- Compressed 与 Dymatic 不同的一点是它会采用压缩算法对页面进行压缩，以节省空间

## 行溢出数据
- 概述：
  - VARCHAR(M) M最多可以占用65535个字节
  - 需要占用3部分存储空间
    - 真实数据
    - 真实数据占用字节的长度,
    - NULL值标识
  - 字符集
    - ascii: 65532
    - utf8: 65532 / 3
    - gbk: 65532 / 2
  - 页 16KB
    - Compact Redundant 模式
      - 前768个字节的数据
      - 20字节：指向真正存储数据的页，这叫：溢出页

- 临界点，什么情况会发生
  - 一个页中至少存放两行记录，我们按一个字段来模拟计算
  - 每个页 本身要用：132个字节
  - 一条记录：额外信息是27字节 以COMPACT行格式
    - 额外信息：
      - 2个字节用于存储真实数据的长度
      - 1个字节用于存储列是否是NULL值
      - 5个字节大小的头信息
    - 记录的真实数据
      - 6个字节的row_id列
      - 6个字节的transaction_id列
      - 7个字节的roll_pointer列
  - 临界点：132 + 2 × (27 + n) < 16384  n < 8099
    - 真实数据超过 8099 发生 行溢出的

## 页基本概念
- 页：16KB,以页为 磁盘和内存之间交互的基本单位
  - 参数：innodb_page_size

- 种类：
  - 索引（INDEX）页
  - 数据页
  - 存放表空间头部信息的页
  - 存放Insert Buffer信息的页
  - 存放INODE信息的页
  - 存放undo日志信息的页

- 组成：

| 名称                 |  中文名            | 占用空间大小	| 简单描述           |
| ------------------- | ----------------- | ---------- | ----------------- |
| File Header         | 文件头部           |  38字节     | 页的一些通用信息     |
| Page Header         | 页面头部           | 56字节      | 数据页专有的一些信息  |
| Infimum + Supremum  | 最小记录和最大记录   | 26字节      | 两个虚拟的行记录     |
| User Records        | 用户记录           | 不确定      | 实际存储的行记录内容  |
| Free Space          | 空闲空间           | 不确定      | 页中尚未使用的空间     |
| Page Directory      | 页面目录           | 不确定      | 页中的某些记录的相对位置 |
| File Trailer        | 文件尾部           | 8字节       | 校验页是否完整          |

- 记录在页中的存储过程
  - 每当我们插入一条记录
  - 从Free Space部分
  - 划分到User Records

- 一个页中至少存放两行记录
  - 每个记录需要的额外信息是27字节
